<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customize Agent &mdash; LibSignal v1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Customize World" href="Customize%20World.html" />
    <link rel="prev" title="Start Experiment" href="Start%20Experiment.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> LibSignal
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Get Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getstart/Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstart/Install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getstart/Start.html">Start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/Config%20Settings.html">Config Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/Dataset%20Introduction.html">Dataset Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/Agents.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/World.html">World</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/Generator.html">Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/Metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/Other%20Usage.html">Other Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Start%20Experiment.html">Start Experiment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Customize Agent</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#create-a-new-agent-class">Create a New Agent Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-init">Implement __init__()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-reset">Implement reset()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-build-model">Implement build_model()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-newmodelnet">Implement NewModelNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-repr">Implement __repr__()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-get-ob">Implement get_ob()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-get-reward">Implement get_reward()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-get-phase">Implement get_phase()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-get-queue">Implement get_queue()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-get-delay">Implement get_delay()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-get-action">Implement get_action()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-sample">Implement sample()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-remember">Implement remember()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-update-target-network">Implement update_target_network()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-train">Implement train()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-load-model">Implement load_model()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-save-model">Implement save_model()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#import-the-model">Import The Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-model-config">Add Model Config</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Customize%20World.html">Customize World</a></li>
<li class="toctree-l1"><a class="reference internal" href="Customize%20Dataset.html">Customize Dataset</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../detailed/API/index.html">API Introduction</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LibSignal</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Customize Agent</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/content/tutorial/Customize Agent.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="customize-agent">
<h1>Customize Agent<a class="headerlink" href="#customize-agent" title="Permalink to this heading">¶</a></h1>
<p>This documentation overviews how to create a new agent, including importing an agent from other libs.</p>
<section id="create-a-new-agent-class">
<h2>Create a New Agent Class<a class="headerlink" href="#create-a-new-agent-class" title="Permalink to this heading">¶</a></h2>
<p>To begin with, we should create a new model implemented from <strong>RLAgent</strong> for RL-based agents or <strong>BaseAgent</strong> for other types of agents.</p>
<p>Here we take the RL-based agent as an example. We would like to develop a new model, named <code class="docutils literal notranslate"><span class="pre">NewModel</span></code>, for traffic signal control tasks.</p>
<p>First please create a new file <code class="docutils literal notranslate"><span class="pre">newmodel.py</span></code> in the directory <code class="docutils literal notranslate"><span class="pre">LibSignal/agent/</span></code> and write the following code into the file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">RLAgent</span>
<span class="kn">from</span> <span class="nn">common.registry</span> <span class="kn">import</span> <span class="n">Registry</span>

<span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">get_ob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">get_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">get_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">get_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">update_target_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">NewModelNet</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>You can see that we use <code class="docutils literal notranslate"><span class="pre">Registry</span></code> to register the new model, define the <code class="docutils literal notranslate"><span class="pre">NewModelNet</span></code> class, and list the methods that must appear in the class.
In the following sections, we take the configuration of DQN model as an example.</p>
</section>
<section id="implement-init">
<h2>Implement __init__()<a class="headerlink" href="#implement-init" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method, which is used to define the model structure according to the parameters of input and configuration information from <code class="docutils literal notranslate"><span class="pre">Registry</span></code>.</p>
<p>The input parameters of <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> are <code class="docutils literal notranslate"><span class="pre">world</span></code> and this intersection’s <code class="docutils literal notranslate"><span class="pre">rank</span></code>. The configuration information from <code class="docutils literal notranslate"><span class="pre">Registry</span></code> contains various model parameters, input parameters required by creating generators and so on.</p>
<p>You can define <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
        <span class="c1"># section 1: get configs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">world</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_agents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">intersections</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">intersection_ids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2intersection</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inter_id</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_hot</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;one_hot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_clip</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;grad_clip&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_decay</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;epsilon_decay&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_min</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;epsilon_min&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vehicle_max</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;vehicle_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;model_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;setting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>

        <span class="c1"># section 2: create generators for each Agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">inter</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lane_count&#39;</span><span class="p">],</span> <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_generator</span> <span class="o">=</span> <span class="n">IntersectionPhaseGenerator</span><span class="p">(</span><span class="n">world</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">inter</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">],</span>
                                                          <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cur_phase&quot;</span><span class="p">],</span> <span class="n">negative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_generator</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">inter</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lane_waiting_count&quot;</span><span class="p">],</span>
                                                     <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">negative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># section 3: set action space and ob_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter</span><span class="o">.</span><span class="n">phases</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_hot</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ob_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span><span class="o">.</span><span class="n">ob_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inter</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ob_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span><span class="o">.</span><span class="n">ob_length</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ob_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span><span class="o">.</span><span class="n">ob_length</span>

        <span class="c1"># section 4: create model, target model and others</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_target_network</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                                       <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                                       <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
</pre></div>
</div>
<p>You can see that in the section 1 of the code, we take the necessary parameters from <code class="docutils literal notranslate"><span class="pre">Registry</span></code> and input parameters.</p>
<p>In the section 2 of the code, we create observation, reward and phase generators for the model. Notes that different models have different input parameters of generators. Since the definitions of queue and delay are unified, queue and delay generators are directly created in the <strong>RLAgent</strong>.</p>
<p>In the section 3 of the code, we set action space list and observation length.</p>
<p>In the section 4 of the code, we create model, target model and others, including a criterion and an optimizer.</p>
<p>.. Note::
For Multi-Agent that shares information among agents, the code for creating generators is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get generators for Agent</span>
<span class="n">observation_generators</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
    <span class="n">node_id</span> <span class="o">=</span> <span class="n">inter</span><span class="o">.</span><span class="n">id</span>
    <span class="n">node_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2idx</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">node_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2intersection</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">tmp_generator</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">node_obj</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lane_count&#39;</span><span class="p">],</span> <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">observation_generators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">tmp_generator</span><span class="p">))</span>
<span class="nb">sorted</span><span class="p">(</span><span class="n">observation_generators</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># now generator&#39;s order is according to its index in graph</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span> <span class="o">=</span> <span class="n">observation_generators</span>

<span class="c1">#  get reward generator</span>
<span class="n">rewarding_generators</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
    <span class="n">node_id</span> <span class="o">=</span> <span class="n">inter</span><span class="o">.</span><span class="n">id</span>
    <span class="n">node_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2idx</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">node_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2intersection</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">tmp_generator</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">node_obj</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lane_waiting_count&quot;</span><span class="p">],</span>
                                            <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">negative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rewarding_generators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">tmp_generator</span><span class="p">))</span>
<span class="nb">sorted</span><span class="p">(</span><span class="n">rewarding_generators</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># now generator&#39;s order is according to its index in graph</span>
<span class="bp">self</span><span class="o">.</span><span class="n">reward_generator</span> <span class="o">=</span> <span class="n">rewarding_generators</span>

<span class="c1">#  get phase generator</span>
<span class="n">phasing_generators</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
    <span class="n">node_id</span> <span class="o">=</span> <span class="n">inter</span><span class="o">.</span><span class="n">id</span>
    <span class="n">node_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2idx</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">node_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2intersection</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">tmp_generator</span> <span class="o">=</span> <span class="n">IntersectionPhaseGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">node_obj</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">],</span>
                                                <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cur_phase&#39;</span><span class="p">],</span> <span class="n">negative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">phasing_generators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">tmp_generator</span><span class="p">))</span>
<span class="nb">sorted</span><span class="p">(</span><span class="n">phasing_generators</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># now generator&#39;s order is according to its index in graph</span>
<span class="bp">self</span><span class="o">.</span><span class="n">phase_generator</span> <span class="o">=</span> <span class="n">phasing_generators</span>

<span class="c1">#  get queue generator</span>
<span class="n">queues</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
    <span class="n">node_id</span> <span class="o">=</span> <span class="n">inter</span><span class="o">.</span><span class="n">id</span>
    <span class="n">node_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2idx</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">node_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2intersection</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">tmp_generator</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">node_obj</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lane_waiting_count&quot;</span><span class="p">],</span> 
                                            <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">negative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">queues</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">tmp_generator</span><span class="p">))</span>
<span class="nb">sorted</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queues</span>

<span class="c1">#  get delay generator</span>
<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
    <span class="n">node_id</span> <span class="o">=</span> <span class="n">inter</span><span class="o">.</span><span class="n">id</span>
    <span class="n">node_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2idx</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">node_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2intersection</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
    <span class="n">tmp_generator</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">node_obj</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lane_delay&quot;</span><span class="p">],</span> 
                                            <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">negative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">tmp_generator</span><span class="p">))</span>
<span class="nb">sorted</span><span class="p">(</span><span class="n">delays</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delays</span>
</pre></div>
</div>
</section>
<section id="implement-reset">
<h2>Implement reset()<a class="headerlink" href="#implement-reset" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">reset()</span></code> method, <code class="docutils literal notranslate"><span class="pre">reset()</span></code> is used to reset information, including ob_generator, phase_generator, reward_generator, queue, delay, etc.
For example, you can define <code class="docutils literal notranslate"><span class="pre">reset()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inter_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">intersection_ids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span>
        <span class="n">inter_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">id2intersection</span><span class="p">[</span><span class="n">inter_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">inter_obj</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lane_count&#39;</span><span class="p">],</span> <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_generator</span> <span class="o">=</span> <span class="n">IntersectionPhaseGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">inter_obj</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">],</span>
                                                          <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cur_phase&quot;</span><span class="p">],</span> <span class="n">negative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_generator</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">inter_obj</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lane_waiting_count&quot;</span><span class="p">],</span>
                                                     <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">negative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">inter_obj</span><span class="p">,</span>
                                                     <span class="p">[</span><span class="s2">&quot;lane_waiting_count&quot;</span><span class="p">],</span> <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">negative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">LaneVehicleGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="n">inter_obj</span><span class="p">,</span>
                                                     <span class="p">[</span><span class="s2">&quot;lane_delay&quot;</span><span class="p">],</span> <span class="n">in_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                                                     <span class="n">negative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>     
</pre></div>
</div>
<p>Note: The above codes are applied for Single-Agent. For Multi-Agent generators, the user must reset by the way of traversing the list.</p>
</section>
<section id="implement-build-model">
<h2>Implement build_model()<a class="headerlink" href="#implement-build-model" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">build_model()</span></code> method, <code class="docutils literal notranslate"><span class="pre">build_model()</span></code> is used to create a model(network). This method will be called by <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> twice for creating the model and target model.
For example, you can define <code class="docutils literal notranslate"><span class="pre">build_model()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">NewModelNet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ob_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>     
</pre></div>
</div>
</section>
<section id="implement-newmodelnet">
<h2>Implement NewModelNet<a class="headerlink" href="#implement-newmodelnet" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">NewModelNet</span></code> class, which is the core of the model. <code class="docutils literal notranslate"><span class="pre">NewModelNet</span></code> class can inherit both the base <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> class and classes already implemented in other libs.</p>
<p>For example, you can define <code class="docutils literal notranslate"><span class="pre">NewModelNet</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NewModelNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NewModelNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="implement-repr">
<h2>Implement __repr__()<a class="headerlink" href="#implement-repr" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">repr()</span></code> method, <code class="docutils literal notranslate"><span class="pre">repr()</span></code> is used to return the <code class="docutils literal notranslate"><span class="pre">self.model</span></code> structure.
For example, you can define <code class="docutils literal notranslate"><span class="pre">__repr__()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>   
</pre></div>
</div>
</section>
<section id="implement-get-ob">
<h2>Implement get_ob()<a class="headerlink" href="#implement-get-ob" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">get_ob()</span></code> method, <code class="docutils literal notranslate"><span class="pre">get_ob()</span></code> is used to get observation from environment.
For Single-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_ob()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_ob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x_obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
        <span class="n">x_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_obs</span>  
</pre></div>
</div>
<p>For Multi-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_ob()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_ob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># sub_agents * lane_nums,</span>
        <span class="n">x_obs</span> <span class="o">=</span> <span class="p">[]</span>  
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span><span class="p">)):</span>
            <span class="n">x_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ob_generator</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_obs</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_obs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x_obs</span>
</pre></div>
</div>
</section>
<section id="implement-get-reward">
<h2>Implement get_reward()<a class="headerlink" href="#implement-get-reward" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">get_reward()</span></code> method, <code class="docutils literal notranslate"><span class="pre">get_reward()</span></code> is used to get reward from environment.
For Single-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_reward()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rewards</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rewards</span>    
</pre></div>
</div>
<p>For Multi-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_reward()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># sub_agents</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_generator</span><span class="p">)):</span>
            <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_generator</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rewards</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rewards</span>
</pre></div>
</div>
</section>
<section id="implement-get-phase">
<h2>Implement get_phase()<a class="headerlink" href="#implement-get-phase" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">get_phase()</span></code> method, <code class="docutils literal notranslate"><span class="pre">get_phase()</span></code> is used to get current phase of intersection(s) from environment.
For Single-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_phase()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span>      
</pre></div>
</div>
<p>For Multi-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_phase()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># sub_agents</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_generator</span><span class="p">)):</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_generator</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">generate</span><span class="p">()))</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span>
</pre></div>
</div>
</section>
<section id="implement-get-queue">
<h2>Implement get_queue()<a class="headerlink" href="#implement-get-queue" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">get_queue()</span></code> method, <code class="docutils literal notranslate"><span class="pre">get_queue()</span></code> is used to get queue length of intersection.
For Single-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_queue()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
        <span class="c1"># sum of lane nums</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">queue</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">queue</span>    
</pre></div>
</div>
<p>For Multi-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_queue()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)):</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">generate</span><span class="p">()))</span>
        <span class="n">tmp_queue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp_queue</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_queue</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queue</span>  
</pre></div>
</div>
</section>
<section id="implement-get-delay">
<h2>Implement get_delay()<a class="headerlink" href="#implement-get-delay" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">get_delay()</span></code> method, <code class="docutils literal notranslate"><span class="pre">get_delay()</span></code> is used to get delay of intersection.
For Single-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_delay()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delay</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">delay</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">delay</span>   
</pre></div>
</div>
<p>For Multi-Agent, you can define <code class="docutils literal notranslate"><span class="pre">get_delay()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)):</span>
            <span class="n">delay</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">generate</span><span class="p">()))</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">delay</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">delay</span> <span class="c1"># [intersections,]       </span>
</pre></div>
</div>
</section>
<section id="implement-get-action">
<h2>Implement get_action()<a class="headerlink" href="#implement-get-action" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">get_action()</span></code> method, <code class="docutils literal notranslate"><span class="pre">get_action()</span></code> is used to generate action according to features. Different models have different features, users only need to input the required parameters.
For DQN, it requires observation and phase as a feature, so you can define <code class="docutils literal notranslate"><span class="pre">get_action()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_hot</span><span class="p">:</span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ob</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">idx2onehot</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ob</span><span class="p">,</span> <span class="n">phase</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">ob</span>
        <span class="n">observation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   
</pre></div>
</div>
</section>
<section id="implement-sample">
<h2>Implement sample()<a class="headerlink" href="#implement-sample" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">sample()</span></code> method, <code class="docutils literal notranslate"><span class="pre">sample()</span></code> is used to sample action randomly.
For example, you can define <code class="docutils literal notranslate"><span class="pre">sample()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_agents</span><span class="p">)</span>     
</pre></div>
</div>
</section>
<section id="implement-remember">
<h2>Implement remember()<a class="headerlink" href="#implement-remember" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">remember()</span></code> method, <code class="docutils literal notranslate"><span class="pre">remember()</span></code> is used to put current step information into the replay buffer for training the agent later.
For example, you can define <code class="docutils literal notranslate"><span class="pre">remember()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_obs</span><span class="p">,</span> <span class="n">last_phase</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">actions_prob</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">cur_phase</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">last_obs</span><span class="p">,</span> <span class="n">last_phase</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">cur_phase</span><span class="p">)))</span>    
</pre></div>
</div>
</section>
<section id="implement-update-target-network">
<h2>Implement update_target_network()<a class="headerlink" href="#implement-update-target-network" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">update_target_network()</span></code> method, <code class="docutils literal notranslate"><span class="pre">update_target_network()</span></code> is used to update params of target network.
For example, you can define <code class="docutils literal notranslate"><span class="pre">update_target_network()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update_target_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> 
</pre></div>
</div>
</section>
<section id="implement-train">
<h2>Implement train()<a class="headerlink" href="#implement-train" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">train()</span></code> method, <code class="docutils literal notranslate"><span class="pre">train()</span></code> is used to train the agent, and optimize the action generated by agent.
For example, you can define <code class="docutils literal notranslate"><span class="pre">train()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#take batch-sized samples from the replay buffer randomly </span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="c1"># convert samples into corresponding formats</span>
        <span class="n">b_t</span><span class="p">,</span> <span class="n">b_tp</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batchwise</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="c1"># put the next_feature into target model</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="p">(</span><span class="n">b_tp</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">rewards</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># put the current_feature into target model</span>
        <span class="n">target_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">b_t</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actions</span><span class="p">):</span>
            <span class="n">target_f</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">b_t</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">target_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_clip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_min</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_decay</span>
        <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
</pre></div>
</div>
</section>
<section id="implement-load-model">
<h2>Implement load_model()<a class="headerlink" href="#implement-load-model" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">load_model()</span></code> method, <code class="docutils literal notranslate"><span class="pre">load_model()</span></code> is used to load model params of an episode.
For example, you can define <code class="docutils literal notranslate"><span class="pre">load_model()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;logger_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                  <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s1">.pt&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_name</span><span class="p">))</span>   
</pre></div>
</div>
</section>
<section id="implement-save-model">
<h2>Implement save_model()<a class="headerlink" href="#implement-save-model" title="Permalink to this heading">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">save_model()</span></code> method, <code class="docutils literal notranslate"><span class="pre">save_model()</span></code> is used to save model params of an episode.
For example, you can define <code class="docutils literal notranslate"><span class="pre">save_model()</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="s1">&#39;NewModel&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NewModelAgent</span><span class="p">(</span><span class="n">RLAgent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Registry</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;logger_mapping&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s1">.pt&#39;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_name</span><span class="p">)</span>
</pre></div>
</div>
<p>.. Note::
If the customized model needs more complex methods, then you can rewrite the corresponding interface mentioned above. If the model is imported from other libs, and some methods have already been included in the library, then users can use “pass” to skip the implementation of the corresponding interface.</p>
</section>
<section id="import-the-model">
<h2>Import The Model<a class="headerlink" href="#import-the-model" title="Permalink to this heading">¶</a></h2>
<p>After adding the model, you need to modify the <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file in <code class="docutils literal notranslate"><span class="pre">LibSignal/agent/__init__.py</span></code>.</p>
<p>Please add code like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.newmodel</span> <span class="kn">import</span> <span class="n">NewModelAgent</span>
</pre></div>
</div>
</section>
<section id="add-model-config">
<h2>Add Model Config<a class="headerlink" href="#add-model-config" title="Permalink to this heading">¶</a></h2>
<p>Then, you need to create the <code class="docutils literal notranslate"><span class="pre">LibSignal/configs/tsc/newmodel.yml</span></code> file, which is used to set the parameters of the model, trainer, world and logger.</p>
<p>For example, you can add codes like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">includes</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">configs</span><span class="o">/</span><span class="n">tsc</span><span class="o">/</span><span class="n">base</span><span class="o">.</span><span class="n">yml</span>

<span class="n">model</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">newmodel</span>
  <span class="n">train_model</span><span class="p">:</span> <span class="kc">True</span>
  <span class="n">epsilon</span><span class="p">:</span> <span class="mf">0.1</span>
  <span class="n">one_hot</span><span class="p">:</span> <span class="kc">True</span>
  <span class="n">phase</span><span class="p">:</span> <span class="kc">True</span>

<span class="n">trainer</span><span class="p">:</span>
  <span class="n">learning_start</span><span class="p">:</span> <span class="mi">1000</span>

<span class="n">world</span><span class="p">:</span>
  <span class="n">signal_config</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">hz1x1</span><span class="p">:</span> <span class="p">{</span>
      <span class="n">phase_pairs</span><span class="p">:</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
      <span class="n">valid_acts</span><span class="p">:</span> <span class="n">null</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="n">logger</span><span class="p">:</span>
    <span class="n">attention</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Note: The filename of the config and the value must be the same as the class name of the model you added. Just like the <code class="docutils literal notranslate"><span class="pre">NewModel</span></code> above.</p>
</br>
<p>Now that you have learned how to add a new model, try the following commands to run this model!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">run</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">a</span> <span class="n">newmodel</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Start%20Experiment.html" class="btn btn-neutral float-left" title="Start Experiment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Customize%20World.html" class="btn btn-neutral float-right" title="Customize World" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, DaRL.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>